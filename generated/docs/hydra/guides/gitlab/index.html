<!doctype html>
<html class="docs-version-v1.10" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setDocumentTitle",document.domain+"/"+document.title]),_paq.push(["setCookieDomain","*.ory.sh"]),_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//sqa-web.ory.sh/";_paq.push(["setTrackerUrl",e+"np.php"]),_paq.push(["setSiteId","2"]);var a=document,p=a.createElement("script"),t=a.getElementsByTagName("script")[0];p.type="text/javascript",p.async=!0,p.src=e+"js/np.min.js",t.parentNode.insertBefore(p,t)}()</script>
<link rel="search" type="application/opensearchdescription+xml" title="ORY Hydra" href="/hydra/docs/opensearch.xml"><title data-react-helmet="true">Gitlab Hydra integration | ORY Hydra</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.ory.sh//hydra/docs/guides/gitlab"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="v1.10"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-v1.10"><meta data-react-helmet="true" property="og:title" content="Gitlab Hydra integration | ORY Hydra"><meta data-react-helmet="true" name="description" content="Gitlab has several OAuth2 related features. The relevant here is the possibility"><meta data-react-helmet="true" property="og:description" content="Gitlab has several OAuth2 related features. The relevant here is the possibility"><link data-react-helmet="true" rel="shortcut icon" href="/hydra/docs/img/favico.png"><link data-react-helmet="true" rel="canonical" href="https://www.ory.sh//hydra/docs/guides/gitlab"><link data-react-helmet="true" rel="alternate" href="https://www.ory.sh//hydra/docs/guides/gitlab" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.ory.sh//hydra/docs/guides/gitlab" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/hydra/docs/assets/css/styles.9686f6b1.css">
<link rel="preload" href="/hydra/docs/assets/js/runtime~main.3d7b2be0.js" as="script">
<link rel="preload" href="/hydra/docs/assets/js/main.6310b44a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div id="route-identifier" data-route="/hydra/docs/guides/gitlab"><div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">Sign up for <a href="https://ory.us10.list-manage.com/subscribe?u=ffb1a878e4ec6c0ed312a3480&id=f605a41b53&group[17097][8]=1">important security announcements</a> and if you like ORY Hydra give it a ‚≠êÔ∏è on <a target="_blank" rel="noopener noreferrer" href="https://github.com/ory/hydra">GitHub</a>!</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.ory.sh/hydra" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img src="/hydra/docs/img/logo-hydra.svg" alt="ORY Hydra" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/hydra/docs/img/logo-hydra.svg" alt="ORY Hydra" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a href="https://www.ory.sh/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Home</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ory/hydra/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.ory.sh/chat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/ory/hydra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/hydra/docs/">v1.10</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/hydra/docs/next/guides/gitlab">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/hydra/docs/guides/gitlab">v1.10</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.9/guides/gitlab">v1.9</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.8/guides/gitlab">v1.8</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.7/">v1.7</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.6/">v1.6</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.5/">v1.5</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.4/">v1.4</a></li><li><a class="dropdown__link" href="/hydra/docs/versions">All versions</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a href="https://www.ory.sh/docs/" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Welcome to Ory!<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a href="https://www.ory.sh/docs/get-started" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Become an Ory Insider<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a href="https://www.ory.sh/docs/early-access" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Ory Cloud Roadmap<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Start Building</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Guides</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a href="https://www.ory.sh/docs/reference/api" target="_blank" rel="noopener noreferrer" class="menu__link"><span>HTTP API Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Reference</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Kratos</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Keto</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Open Source Ory Hydra</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Concepts</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Implementing the User Interface</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Operations</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/configure-deploy">Run ORY Hydra in Docker</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/dependencies-environment">Database Setup and Configuration</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/production">Preparing for Production</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/tracing">Distributed Tracing</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/secrets-key-rotation">Secrets and Key Rotation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/kubernetes-helm-chart">Kubernetes Helm Chart</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/ssl-https-tls">SSL/TLS, HTTPS, Self-Signed Certificates</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/cookies">Configuring Cookies</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/scaling-hydra">Scaling ORY Hydra</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/cors">Setting up Cross-origin resource sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/hydra/docs/guides/gitlab">Gitlab Hydra integration</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/migrating-from-mitreid">Migrating from MITREid</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/guides/merge-multiple-db-secrets">Merge multiple system.secrets</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">OAuth2 &amp; OpenID Connect</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/reference/api">HTTP API</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Reference</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Debug &amp; Help</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">SDKs</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Development</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Further Reading</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Oathkeeper</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: v1.10</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Gitlab Hydra integration</h1></header><p>Gitlab has several OAuth2 related features. The relevant here is the possibility
to sign into GitLab with (almost) any OAuth2 provider, in this case ORY Hydra.
So, in this guide, we&#x27;ll connect GitLab&#x27;s omniauth-connector to ORY Hydra. We&#x27;ll
do that in a docker-based lab-environment in order to investigate the details
before you do something like this in production.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="preparation"></a>Preparation<a class="hash-link" href="#preparation" title="Direct link to heading">#</a></h2><p>Even though we&#x27;re mostly using ORY Hydra in a docker-container, having the
command-line-client available is quite useful. So please install ORY Hydra as
explained in the <a href="/hydra/docs/install">installation-guide</a>. You&#x27;ll also need
<a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">docker</a> and
<a href="https://docs.docker.com/compose/install/" target="_blank" rel="noopener noreferrer">docker-compose</a>.</p><p>The <a href="/hydra/docs/5min-tutorial">5-min-tutorial</a> might be worth checking out upfront.
It&#x27;ll a give a nice quick overview how OAuth2 is working within ORY Hydra with a
minimal example. We assume basic knowledge, here.</p><p>If you have not yet the source code of ORY Hydra, which we&#x27;ll need for the
<code>docker-compose</code> yaml-files and the gitlab-configuration, clone the repository:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/ory/hydra.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We will access GitLab via the url <a href="http://gitlab.example.com." target="_blank" rel="noopener noreferrer">http://gitlab.example.com.</a> So we need to map
it to localhost. This is done by modifying the hosts-file. On an unixoid system
find this file in <code>/etc/hosts</code>, on windows, you should find it in
<code>c:\WINDOWS\system32\drivers\etc\hosts</code>. Add this line:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1 gitlab.example.com</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As this POC will work with http instead of https, we need to whitelist the above
domain-name to allow unencrypted http traffic. So add the following switch to
the services.hydra.command-section in the quickstart.yml around line 24 so that
the line looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    serve all --dangerous-allow-insecure-redirect-urls http://gitlab.example.com:8000/users/auth/ORY_Hydra/callback</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="spin-up-the-instances-and-logging-in"></a>Spin up the instances and logging in<a class="hash-link" href="#spin-up-the-instances-and-logging-in" title="Direct link to heading">#</a></h2><p>Use this command to spinup the instances. This will show the logs on the
terminal and it will take some time.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose -f quickstart.yml </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -f quickstart-postgres.yml -f ./contrib/quickstart/quickstart-gitlab.yml </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    up --build</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After this suceeds, you can access the login page
<a href="http://localhost:8000/users/sign_in" target="_blank" rel="noopener noreferrer">sign-in-page</a>. Don&#x27;t try to login, yet, we
have to create the client in ORY Hydra, first.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="creating-the-client-in-ory-hydra"></a>Creating the client in ORY Hydra<a class="hash-link" href="#creating-the-client-in-ory-hydra" title="Direct link to heading">#</a></h2><p>Depending on whether you&#x27;ve the hydra-binary available, you can use it directly
or the one in the docker-container.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ hydra clients create </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --endpoint http://127.0.0.1:4445 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --id gitlab </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secret theSecret </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --grant-types authorization_code,refresh_token </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --response-types code,id_token, email </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --scope openid,offline_access,profile,email </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --callbacks http://gitlab.example.com:8000/users/auth/ORY_Hydra/callback </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --token-endpoint-auth-method client_secret_post</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>or you can use the binary within the docker-container:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose -f quickstart.yml </span><span class="token builtin class-name">exec</span><span class="token plain"> hydra </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    hydra clients create </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --endpoint http://127.0.0.1:4445 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --id gitlab </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secret theSecret </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --grant-types authorization_code,refresh_token </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --response-types code,id_token,email </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --scope openid,offline_access,profile,email </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --callbacks http://gitlab.example.com:8000/users/auth/ORY_Hydra/callback </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --token-endpoint-auth-method client_secret_post</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="oauth2-login"></a>OAuth2 Login<a class="hash-link" href="#oauth2-login" title="Direct link to heading">#</a></h2><p>With the first access of your
<a href="http://gitlab.example.com:8000/" target="_blank" rel="noopener noreferrer">GitLab-instance</a>, you will have to change the
root-password. You should see a &quot;Ory Hydra&quot; Login-button. Clicking it will
forward you to the hydra-consent-app where you can login with <a href="mailto:foo@bar.com" target="_blank" rel="noopener noreferrer">foo@bar.com</a>/foobar
similiar to the 5-min-tutorial. After that you have to give consent to accessing
your email-address. Congratulations, doing that should redirect you directly to
your personal GitLab-page. You have logged into GitLab via ORY Hydra.</p><p>So now, let&#x27;s look at the individual pieces and how all of them work together.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="docker-setup"></a>Docker-setup<a class="hash-link" href="#docker-setup" title="Direct link to heading">#</a></h2><p>Gitlab has some <a href="https://docs.gitlab.com/omnibus/docker/" target="_blank" rel="noopener noreferrer">documentation</a> about
how to use their docker-images. It has also an example for docker-compose. The
<code>quickstart-gitlab.yaml</code> file in the contrib directory doesn&#x27;t contain
surprising things:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;3&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gitlab</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gitlab/gitlab</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ce</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">13.0.6</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ce.0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gitlab.example.com</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">GITLAB_OMNIBUS_CONFIG</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        external_url &#x27;http://gitlab.example.com:8000/&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;8000:8000&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># http</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./contrib/quickstart/gitlab/config:/etc/gitlab&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./contrib/quickstart/gitlab/logs:/var/log/gitlab&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./contrib/quickstart/gitlab/data:/var/opt/gitlab&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Other then <code>logs</code> and <code>data</code>, the config directory is already prepopulated and
the single most important configuration-file is the <code>gitlab.rb</code> file. GitLab has
a mechanism to override values and we use it here to specify the <code>external_url</code>.</p><p>So let&#x27;s move on to <code>gitlab.rb</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="gitlab-configuration---oauth2-setup"></a>GitLab configuration - OAuth2-setup<a class="hash-link" href="#gitlab-configuration---oauth2-setup" title="Direct link to heading">#</a></h2><p>The gitLab-configuration in <code>contrib/quickstart/gitlab/config/gitlab.rb</code> is the
original &quot;template&quot; which consists of 2400 lines of comments on how to do stuff.
Our relevant configuration starts at line 432 where the corresponding comments
about OAuth2 is located as well. It looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><pre tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gitlab_rails[&#x27;omniauth_enabled&#x27;] = true</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gitlab_rails[&#x27;omniauth_block_auto_created_users&#x27;] = false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gitlab_rails[&#x27;omniauth_allow_single_sign_on&#x27;] = [&#x27;ORY_Hydra&#x27;]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gitlab_rails[&#x27;omniauth_providers&#x27;] = [</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;name&#x27; =&gt; &#x27;oauth2_generic&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;app_id&#x27; =&gt; &#x27;gitlab&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;app_secret&#x27; =&gt; &#x27;theSecret&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;args&#x27; =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      client_options: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;site&#x27; =&gt; &#x27;http://127.0.0.1:4444&#x27;, # including port if necessary</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;user_info_url&#x27; =&gt; &#x27;http://hydra:4444/userinfo&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;authorize_url&#x27; =&gt; &#x27;http://127.0.0.1:4444/oauth2/auth&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;token_url&#x27; =&gt; &#x27;http://hydra:4444/oauth2/token&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      user_response_structure: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        root_path: [],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        id_path: &#x27;sub&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        attributes: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                email: &#x27;sub&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      authorize_params: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scope: &#x27;email&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # optionally, you can add the following two lines to &quot;white label&quot; the display name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # of this strategy (appears in urls and Gitlab login buttons)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # If you do this, you must also replace oauth2_generic, everywhere it appears above, with the new name.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: &#x27;ORY_Hydra&#x27;, # display name for this strategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      #strategy_class: &quot;OmniAuth::Strategies::OAuth2Generic&quot; # Devise-specific config option Gitlab uses to find renamed strategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The documentation for this, other then inside the file, is a bit scattered:</p><ul><li>A specific
<a href="https://docs.gitlab.com/ee/integration/oauth2_generic.html" target="_blank" rel="noopener noreferrer">step-by-step guide</a>
but not very detailed</li><li><a href="https://docs.gitlab.com/ee/integration/omniauth.html#initial-omniauth-configuration" target="_blank" rel="noopener noreferrer">OmniAuth reference documentation in GitLab</a></li><li><a href="https://docs.gitlab.com/ee/integration/oauth2_generic.html" target="_blank" rel="noopener noreferrer">OmniAuth Generic reference documenation in GitLab</a></li><li><a href="https://gitlab.com/satorix/omniauth-oauth2-generic#gitlab-config-example" target="_blank" rel="noopener noreferrer">OmniAuth Gem-documentation from Satorix</a></li></ul><p>The biggest-source for errors is the clients-options-section. Here we&#x27;ll specify
the details for the OAuth2 flow and where ORY Hydra is located. Two things are
extremely important to keep in your mind when looking at configurations which
are specifying some flow one way or another:</p><ul><li>Where is the DNS-name resolved? Sometimes it&#x27;s on the users browser, sometimes
on GitLab or on the hydra-side. Especially in our docker-based POC, it makes a
huge difference!</li><li>Cookies can only be written/read, if they are from the same domain. In that
case &quot;127.0.0.1&quot;. That would be a different domain than &quot;localhost&quot;. Pay
attention to that.</li></ul><p>These two points in our mind, let&#x27;s look at the three configurations:</p><ul><li><code>&#x27;site&#x27; =&gt; &#x27;http://127.0.0.1:4444&#x27;</code> This is the default for the three URLs
later if not specified otherwise.</li><li><code>&#x27;authorize_url&#x27; =&gt; &#x27;http://127.0.0.1:4444/oauth2/auth&#x27;</code> this url will be a
redirect-target and therefore resolved on the browser of the user. Probably we
could omit the scheme, host and port as this is already defined in <code>site</code>.</li><li><code>&#x27;token_url&#x27; =&gt; &#x27;http://hydra:4444/oauth2/token&#x27;</code> the <code>token_url</code> will get
used on the GitLab-server to get a token after GitLab received the grant. As
it&#x27;s resolved on the GitLab-side, we&#x27;re using docker-name of the
hydra-container which is by default resolvable on the GitLab-container.</li><li><code>&#x27;user_info_url&#x27; =&gt; &#x27;http://hydra:4444/userinfo&#x27;,</code> same thing for the
<code>user_info_url</code>. It&#x27;s called on the GitLab-container and needs to be
resolvable there.</li></ul><p>The paths here are by default the same paths which are specified by OpenID
connect. The configuration would be simpler if we would use OpenID-Connect (more
about that later in the appendix) but in our case we&#x27;re simply manually
specifying the values. So it&#x27;s not an accident that these pathes here are the
very same then what you get from ORY Hydra:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:4444/.well-known/openid-configuration </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq </span><span class="token builtin class-name">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;issuer&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:4444/&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;authorization_endpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:4444/oauth2/auth&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;token_endpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:4444/oauth2/token&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;jwks_uri&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:4444/.well-known/jwks.json&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;userinfo_endpoint&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:4444/userinfo&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;scopes_supported&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;offline_access&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;offline&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;openid&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;token_endpoint_auth_methods_supported&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;client_secret_post&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;client_secret_basic&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;private_key_jwt&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;none&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Also worth noting here is the supported <code>token_endpoint_auth_methods</code>: How does
GitLab authenticate against ORY Hydra? So GitLab is using <code>client_secret_post</code>
which we needed to specify when we&#x27;ve created the GitLab-client in ORY Hydra.</p><p>Some remarks for creating the client. We have created the client like this. The
second command shows the created client:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ hydra clients create </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --endpoint http://127.0.0.1:4445 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --id gitlab </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secret theSecret </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --grant-types authorization_code,refresh_token </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --response-types code,id_token, email </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --scope openid,offline_access,profile,email </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --callbacks http://gitlab.example.com:8000/users/auth/ORY_Hydra/callback </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --token-endpoint-auth-method client_secret_post</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hydra clients get hydra --endpoint http://127.0.0.1:4445</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;client_id&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gitlab&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;created_at&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2020-08-31T08:47:30.000Z&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;grant_types&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;authorization_code&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;refresh_token&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;jwks&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;metadata&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;redirect_uris&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;http://gitlab.example.com:8000/users/auth/ORY_Hydra/callback&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;response_types&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;code&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;id_token&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;scope&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;openid offline_access profile email&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;subject_type&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;token_endpoint_auth_method&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;client_secret_post&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;updated_at&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2020-08-31T08:47:30.000Z&quot;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;userinfo_signed_response_alg&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;none&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>The endpoint is not part of the configuration but it&#x27;s a command-line-switch
telling the hydra-binary to which hydra-instance to talk to</li><li><code>id</code> and <code>secret</code> has been specified before in the GitLab-config</li><li>the token-endpoint-auth-method is by default <code>client_secret_basic</code> but GitLab
is using <code>client_secret_post</code> (couldn&#x27;t find that anywhere in the
GitLab-documentation, though)</li><li>The callback needs to be resolvable on the users-browser. However, originally,
the callback-url is created on the GitLab-side. In order to make that
resolvable on the client, we set the <code>external_url</code> in the
GitLab-configuration. Here that value is just there to cross-check with the
generated one. It needs to match exactly.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="proper-gitlab-user-creation"></a>Proper GitLab user-creation<a class="hash-link" href="#proper-gitlab-user-creation" title="Direct link to heading">#</a></h2><p>Initially, GitLab doesn&#x27;t have any user but it needs them in order to manage
authorisation, no matter how the login is done. This is a common issue and a
common solution to this is to create the users on the fly with the first login.
So in order to do that, these lines are enabling that:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><pre tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gitlab_rails[&#x27;omniauth_block_auto_created_users&#x27;] = false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gitlab_rails[&#x27;omniauth_allow_single_sign_on&#x27;] = [&#x27;ORY_Hydra&#x27;]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In order to get the necessary data for the user, gitlab needs to call to hydra&#x27;s
<a href="/hydra/docs/reference/api#openid-connect-userinfo">userinfo-endpoint</a>. The most
important attribute is the sub-attribute which provides, according to the
<a href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken" target="_blank" rel="noopener noreferrer">specification</a>,
the ID of a user which is (in this case) the email-address. However, the
email-address is also an attribute in the specification but in the
implementation of the of this one hardcoded user (<a href="mailto:foo@bar.com" target="_blank" rel="noopener noreferrer">foo@bar.com</a>) is empty.</p><p>So therefore we&#x27;re specifying a mapping telling gitlab it should take the
sub-field and use it as email:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><pre tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">      user_response_structure: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        root_path: [],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        id_path: &#x27;sub&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        attributes: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                email: &#x27;sub&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Whether the attribute &quot;email&quot; is there or not is quite critical here. The
Login-ID has the form of an email. So in order to satisfy Gitlab&#x27;s requirement,
we&#x27;re mapping here the email-attribute to the Login-ID which is represented by
&quot;sub&quot;. This shouldn&#x27;t be necessary in a real-world-implementation.</p><p>But assuming that it&#x27;s not doing that mapping, then GitLab would need to ask ORY
Hydra on that endpoint the email-address. But is GitLab even allowed to read it?
We need consent from the user for that and fortunately we configured the client
above to be able to ask for that scope. However, we also need to configure
GitLab to actually ask for that scope:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">     authorize_params: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           scope: &#x27;email&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>We&#x27;ve successfully integrated GitLab with ORY Hydra. Everything was done as
configuration. No code has been created nor has any application been
monkey-patched while following this guide (so far).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="troubleshooting"></a>Troubleshooting<a class="hash-link" href="#troubleshooting" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="client-wrong"></a>Client wrong<a class="hash-link" href="#client-wrong" title="Direct link to heading">#</a></h3><p>After trying to login you get a message like this:</p><blockquote><p>Error: invalid_client Description: Client authentication failed (e.g., unknown
client, no client authentication included, or unsupported authentication
method) Hint: The requested OAuth 2.0 Client does not exist.</p></blockquote><p>Doublecheck your registered clients. Mae sure ID and password are correct and
matches that of the gitlab.rb:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ hydra clients list --endpoint http://127.0.0.1:4445</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLIENT ID </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> NAME </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> RESPONSE TYPES </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">             SCOPE              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                        REDIRECT URIS                         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">           GRANT TYPES            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> TOKEN ENDPOINT AUTH METHOD </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">----------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">--------------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">--------------------------------------------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">----------------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> gitlab    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> code,id_token, </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> openid offline_access profile  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://gitlab.example.com:8000/users/auth/ORY_Hydra/callback </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> authorization_code,refresh_token </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> client_secret_post         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> email                          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                                                              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                                  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="from-hydra-request-is-missing--or-otherwise-malformed"></a>From Hydra: request is missing ... or otherwise malformed<a class="hash-link" href="#from-hydra-request-is-missing--or-otherwise-malformed" title="Direct link to heading">#</a></h3><p>So after this, clicking the login-button on the
<a href="http://localhost:8000/users/sign_in" target="_blank" rel="noopener noreferrer">sign-in-page</a> will forward to Ory Hydra,
which will redirect to the consent-app on port 3000. After the login, you&#x27;d get
to the granting-page of the consent-app and after you&#x27;ve &quot;allowed access&quot;,
you&#x27;ll get redirected back to gitlab which will unfortunately mention:</p><blockquote><p>Could not authenticate you from ORYHydra because &quot;The request is missing a
required parameter, includes an invalid parameter value, includes a parameter
more than once, or is otherwise malformed&quot;.</p></blockquote><p>So the message in quotes is from ORY Hydra and not very expressive. Note that
it&#x27;s a bit difficult to expose very meaningful error-messages as this could be
used for security-attacks. So in such cases check the hydra-logs on what&#x27;s
wrong.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ory-hydra-logs-redirect-url-is-using-an-insecure-protocol"></a>ORY Hydra Logs: Redirect URL is using an insecure protocol<a class="hash-link" href="#ory-hydra-logs-redirect-url-is-using-an-insecure-protocol" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">hydra_1          | time=2020-08-24T12:42:36Z level=error msg=An error occurred</span></span><span class="token-line" style="color:#393A34"><span class="token plain">audience=application error=map[message:invalid_request reason:Redirect URL is</span></span><span class="token-line" style="color:#393A34"><span class="token plain">using an insecure protocol, http is only allowed for hosts with suffix `localhost`,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for example: http://myapp.localhost/. status:Bad Request status_code:400]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">http_request=map[headers:map[accept:text/html,application/xhtml+xml,application/xml;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">q=0.9,image/webp,*/*;q=0.8 accept-encoding:gzip, deflate accept-language:en-US,en;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">q=0.5 cookie:Value is sensitive and has been redacted. To see the value set config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">key &quot;log.leak_sensitive_values = true&quot; or environment variable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;LOG_LEAK_SENSITIVE_VALUES=true&quot;. referer:http://127.0.0.1:3000/consent?consent_challenge=b695307490fa4732a80d3324f45f5a93</span></span><span class="token-line" style="color:#393A34"><span class="token plain">user-agent:Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">host:127.0.0.1:4444 method:GET path:/oauth2/auth query:Value is sensitive and has</span></span><span class="token-line" style="color:#393A34"><span class="token plain">been redacted. To see the value set config key &quot;log.leak_sensitive_values = true&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">or environment variable &quot;LOG_LEAK_SENSITIVE_VALUES=true&quot;.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">remote:172.19.0.1:47684 scheme:http] service_name= service_version=</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The relevant part here is: <code>Redirect URL is using an insecure protocol</code>. Make
sure to add the --dangerous-force-http to the hydra-command as described above.</p><p>After that, restart the hydra-container like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose -f quickstart.yml </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -f quickstart-postgres.yml -f quickstart-gitlab.yml </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    restart hydra</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="gitlab-signing-in--is-not-allowed"></a>GitLab: Signing in ... is not allowed<a class="hash-link" href="#gitlab-signing-in--is-not-allowed" title="Direct link to heading">#</a></h3><blockquote><p>Signing in using your Ory Hydra account without a pre-existing GitLab account
is not allowed. Create a GitLab account first, and then connect it to your Ory
Hydra account.</p></blockquote><p>Double-Check the above explanation about user-creation.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="gitlab-email-cant-be-blank"></a>GitLab: Email can&#x27;t be blank<a class="hash-link" href="#gitlab-email-cant-be-blank" title="Direct link to heading">#</a></h3><blockquote><p>Sign-in failed because Email can&#x27;t be blank and Notification email can&#x27;t be
blank.</p></blockquote><p>Double-check the <code>user_response_structure</code> and the <code>authorize_params</code>. The
<code>attributes</code> need an email-entry.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="appendix-some-notes-about-openid-connect"></a>Appendix: Some notes about OpenID connect<a class="hash-link" href="#appendix-some-notes-about-openid-connect" title="Direct link to heading">#</a></h2><p>GitLab is supporting OpenID-Connect and ORY Hydra does that as well. Why hasn&#x27;t
that been used in this guide?</p><p>OpenID might be the better choice then plain OAuth2. When we tried that, we ran
into the issue that the used OpenID-connect-implementation does not allow
http-connection but &quot;only&quot; https. That&#x27;s in general a good thing but stupid for
POCs like this. Whereas ORY Hydra has a switch to whitelist URLs in such cases,
the used
<a href="https://github.com/nov/openid_connect/issues/47" target="_blank" rel="noopener noreferrer">openid-connect-implementation</a>
doesn&#x27;t seem to have that. So, here is a reasonable openID-Connect
configuration:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><pre tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gitlab_rails[&#x27;omniauth_providers&#x27;] = [</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  { &#x27;name&#x27; =&gt; &#x27;openid_connect&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;label&#x27; =&gt; &#x27;ORY Hydra&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # &#x27;icon&#x27; =&gt; &#x27;&lt;custom_provider_icon&gt;&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;args&#x27; =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;name&#x27; =&gt; &#x27;openid_connect&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;scope&#x27; =&gt; [&#x27;openid&#x27;],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;response_type&#x27; =&gt; &#x27;code&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;issuer&#x27; =&gt; &#x27;http://127.0.0.1:4444/&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;discovery&#x27; =&gt; true,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;client_auth_method&#x27; =&gt; &#x27;basic&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;send_scope_to_token_endpoint&#x27; =&gt; &#x27;false&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;client_options&#x27; =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;identifier&#x27; =&gt; &#x27;gitlab&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;secret&#x27; =&gt; &#x27;theSecret&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;redirect_uri&#x27; =&gt; &#x27;http://gitlab.example.com:8000/users/auth/openid_connect/callback&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In order to make that work which is not ssl, we need to patch the openid_connect
gem. Checkout the details
<a href="https://github.com/nov/openid_connect/issues/47" target="_blank" rel="noopener noreferrer">here</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose -f quickstart.yml  -f quickstart-postgres.yml -f quickstart-gitlab.yml </span><span class="token builtin class-name">exec</span><span class="token plain"> gitlab /opt/gitlab/embedded/lib/ruby/gems/2.6.0/gems/openid_connect-1.1.8/lib/openid_connect/discovery/provider/config.rb</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">          def initialize(uri)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @host = uri.host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @port = uri.port unless [80, 443].include?(uri.port)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @path = File.join uri.path, &#x27;.well-known/openid-configuration&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @scheme = uri.scheme</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            attr_missing!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          def endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case scheme</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            when &quot;http&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              SWD.url_builder = URI::HTTP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              SWD.url_builder = URI::HTTPS</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SWD.url_builder.build [nil, host, port, path, nil, nil]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          rescue URI::Error =&gt; e</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            raise SWD::Exception.new(e.message)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In order to avoid that scenario, this guide avoids OpenID-Connect. There might
also be other <a href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/62208" target="_blank" rel="noopener noreferrer">issues</a>
with OpenID-Connect on GitLab.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ory/hydra/edit/master/docs/versioned_docs/version-v1.10/guides/gitlab.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated on <b><time datetime="2021-03-25T11:36:27.000Z">3/25/2021</time></b> by <b>aeneasr</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/hydra/docs/guides/cors"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Setting up Cross-origin resource sharing (CORS)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/hydra/docs/guides/migrating-from-mitreid"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Migrating from MITREid ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preparation" class="table-of-contents__link">Preparation</a></li><li><a href="#spin-up-the-instances-and-logging-in" class="table-of-contents__link">Spin up the instances and logging in</a></li><li><a href="#creating-the-client-in-ory-hydra" class="table-of-contents__link">Creating the client in ORY Hydra</a></li><li><a href="#oauth2-login" class="table-of-contents__link">OAuth2 Login</a></li><li><a href="#docker-setup" class="table-of-contents__link">Docker-setup</a></li><li><a href="#gitlab-configuration---oauth2-setup" class="table-of-contents__link">GitLab configuration - OAuth2-setup</a></li><li><a href="#proper-gitlab-user-creation" class="table-of-contents__link">Proper GitLab user-creation</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li><li><a href="#troubleshooting" class="table-of-contents__link">Troubleshooting</a><ul><li><a href="#client-wrong" class="table-of-contents__link">Client wrong</a></li><li><a href="#from-hydra-request-is-missing--or-otherwise-malformed" class="table-of-contents__link">From Hydra: request is missing ... or otherwise malformed</a></li><li><a href="#ory-hydra-logs-redirect-url-is-using-an-insecure-protocol" class="table-of-contents__link">ORY Hydra Logs: Redirect URL is using an insecure protocol</a></li><li><a href="#gitlab-signing-in--is-not-allowed" class="table-of-contents__link">GitLab: Signing in ... is not allowed</a></li><li><a href="#gitlab-email-cant-be-blank" class="table-of-contents__link">GitLab: Email can&#39;t be blank</a></li></ul></li><li><a href="#appendix-some-notes-about-openid-connect" class="table-of-contents__link">Appendix: Some notes about OpenID connect</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.ory.sh/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.ory.sh/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://www.ory.sh/tos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div>Copyright ¬© 2021 ORY GmbH</div></div></div></footer></div></div>
<script src="/hydra/docs/assets/js/runtime~main.3d7b2be0.js"></script>
<script src="/hydra/docs/assets/js/main.6310b44a.js"></script>
<noscript><p><img src="//sqa-web.ory.sh/np.php?idsite=2&amp;rec=1" style="border:0;" alt=""></p></noscript></body>
</html>