"use strict";(self.webpackChunkdocusaurus_template=self.webpackChunkdocusaurus_template||[]).push([[7114],{3905:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return h}});var i=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=i.createContext({}),p=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},d=function(e){var n=p(e.components);return i.createElement(s.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},u=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(t),h=a,k=u["".concat(s,".").concat(h)]||u[h]||c[h]||o;return t?i.createElement(k,r(r({ref:n},d),{},{components:t})):i.createElement(k,r({ref:n},d))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,r=new Array(o);r[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,r[1]=l;for(var p=2;p<o;p++)r[p]=t[p];return i.createElement.apply(null,r)}return i.createElement.apply(null,t)}u.displayName="MDXCreateElement"},34168:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return d},default:function(){return u}});var i=t(87462),a=t(63366),o=(t(67294),t(3905)),r=["components"],l={id:"advanced",title:"Advanced Topics"},s=void 0,p={unversionedId:"advanced",id:"version-v1.5/advanced",isDocsHomePage:!1,title:"Advanced Topics",description:"This guide aims to help setting up a production system with ORY Hydra.",source:"@site/versioned_docs/version-v1.5/advanced.md",sourceDirName:".",slug:"/advanced",permalink:"/hydra/docs/v1.5/advanced",editUrl:"https://github.com/ory/hydra/edit/master/docs/versioned_docs/version-v1.5/advanced.md",tags:[],version:"v1.5",lastUpdatedBy:"Natalia",lastUpdatedAt:1601673997,formattedLastUpdatedAt:"10/2/2020",frontMatter:{id:"advanced",title:"Advanced Topics"},sidebar:"version-v1.5/docs",previous:{title:"Common Problems & Debugging",permalink:"/hydra/docs/v1.5/debugging"},next:{title:"Consuming OAuth 2.0",permalink:"/hydra/docs/v1.5/integration"}},d=[{value:"Self-Signed SSL",id:"self-signed-ssl",children:[],level:2},{value:"Mobile &amp; Browser (SPA) Authorization",id:"mobile--browser-spa-authorization",children:[{value:"Creating a public OAuth 2.0 Client",id:"creating-a-public-oauth-20-client",children:[],level:3}],level:2},{value:"Key rotation",id:"key-rotation",children:[{value:"Rotation of JSON Web Token Signing Keys",id:"rotation-of-json-web-token-signing-keys",children:[{value:"OpenID Connect ID Token",id:"openid-connect-id-token",children:[],level:4},{value:"OAuth 2.0 Access Tokens (JSON Web Token)",id:"oauth-20-access-tokens-json-web-token",children:[],level:4}],level:3},{value:"Rotation of HMAC Token Signing and Database and Cookie Encryption Keys",id:"rotation-of-hmac-token-signing-and-database-and-cookie-encryption-keys",children:[],level:3}],level:2},{value:"OAuth 2.0",id:"oauth-20",children:[{value:"Audience",id:"audience",children:[{value:"OAuth 2.0 Authorization Code, Implicit, Hybrid Flows",id:"oauth-20-authorization-code-implicit-hybrid-flows",children:[],level:4},{value:"OAuth 2.0 Client Credentials Grant",id:"oauth-20-client-credentials-grant",children:[],level:4}],level:3},{value:"JSON Web Tokens",id:"json-web-tokens",children:[{value:"JSON Web Token Validation",id:"json-web-token-validation",children:[],level:4}],level:3},{value:"OAuth 2.0 Client Authentication with private/public keypairs",id:"oauth-20-client-authentication-with-privatepublic-keypairs",children:[],level:3}],level:2},{value:"OpenID Connect",id:"openid-connect",children:[{value:"Subject Identifier Algorithms",id:"subject-identifier-algorithms",children:[],level:3},{value:"Using login_hint with Different Subject",id:"using-login_hint-with-different-subject",children:[],level:3}],level:2},{value:"CORS",id:"cors",children:[],level:2},{value:"Cookies",id:"cookies",children:[],level:2}],c={toc:d};function u(e){var n=e.components,t=(0,a.Z)(e,r);return(0,o.kt)("wrapper",(0,i.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"This guide aims to help setting up a production system with ORY Hydra."),(0,o.kt)("h2",{id:"self-signed-ssl"},"Self-Signed SSL"),(0,o.kt)("p",null,"If you want to run ORY Hydra using self-signed TLS certificates, you can do the\nfollowing:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ openssl genrsa -out key.pem 4096\n$ openssl req -new -x509 -sha256 -key key.pem -out cert.crt -days 365\n\n$ SERVE_TLS_CERT_BASE64=$(base64 -i cert.crt)\n$ SERVE_TLS_KEY_BASE64=$(base64 -i key.pem)\n\n# or\n\n$ SERVE_TLS_KEY_PATH=/path/to/key.pem\n$ SERVE_TLS_CERT_PATH=/path/to/cert.crt\n")),(0,o.kt)("p",null,"If you run Docker locally, you can then use"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ docker run ... \\\n    -e SERVE_TLS_CERT_BASE64=$(SERVE_TLS_CERT_BASE64) \\\n    -e SERVE_TLS_KEY_BASE64=$(SERVE_TLS_KEY_BASE64) \\\n    ...\n")),(0,o.kt)("p",null,"or mount the files using ",(0,o.kt)("inlineCode",{parentName:"p"},"--mount")," and linking to the files."),(0,o.kt)("h2",{id:"mobile--browser-spa-authorization"},"Mobile & Browser (SPA) Authorization"),(0,o.kt)("p",null,"We have an\n",(0,o.kt)("a",{parentName:"p",href:"https://www.ory.sh/oauth2-for-mobile-app-spa-browser"},"excellent blog post")," on\nthis topic. Read it now!"),(0,o.kt)("h3",{id:"creating-a-public-oauth-20-client"},"Creating a public OAuth 2.0 Client"),(0,o.kt)("p",null,"You can create a public OAuth 2.0 Client (e.g. for the authorize code + PKCE or\nimplicit flow) with the CLI"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"hydra clients create --endpoint http://ory-hydra-admin-api --token-endpoint-auth-method none\n")),(0,o.kt)("p",null,"or by setting in the HTTP API JSON body when POSTing to ",(0,o.kt)("inlineCode",{parentName:"p"},"/clients"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'{\n    "client_id": "...",\n    "token_endpoint_auth_method": "none"\n}\n')),(0,o.kt)("p",null,"Be aware that when making requests to ",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/token")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/revoke")," with a\npublic OAuth 2.0 Client, you can not authenticate with the HTTP Basic\nAuthorization but must include the ",(0,o.kt)("inlineCode",{parentName:"p"},"client_id")," in the POST body."),(0,o.kt)("h2",{id:"key-rotation"},"Key rotation"),(0,o.kt)("p",null,"There are two types of key rotation:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Rotation of JSON Web Token Signing Keys"),(0,o.kt)("li",{parentName:"ul"},"Rotation of HMAC Token Signing and Database and Cookie Encryption Keys")),(0,o.kt)("h3",{id:"rotation-of-json-web-token-signing-keys"},"Rotation of JSON Web Token Signing Keys"),(0,o.kt)("p",null,"JSON Web Token Signing Key rotation is simple with ORY Hydra. You can rotate\nOpenID Connect ID Token and OAuth 2.0 Access Tokens, when using the JSON Web\nToken strategy, keys with one simple command."),(0,o.kt)("p",null,"ORY Hydra takes the latest key from the key store to sign JSON Web Tokens. All\npublic keys will be shown at\n",(0,o.kt)("inlineCode",{parentName:"p"},"http://ory-hydra-public-api/.well-known/jwks.json"),"."),(0,o.kt)("h4",{id:"openid-connect-id-token"},"OpenID Connect ID Token"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"hydra keys create --endpoint=http://ory-hydra-admin-api/ hydra.openid.id-token -a RS256\n")),(0,o.kt)("h4",{id:"oauth-20-access-tokens-json-web-token"},"OAuth 2.0 Access Tokens (JSON Web Token)"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"This will only work when using the JWT access token strategy. Otherwise, this\nwill have no effect.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"hydra keys create --endpoint=http://ory-hydra-admin-api/ hydra.jwt.access-token -a RS256\n")),(0,o.kt)("h3",{id:"rotation-of-hmac-token-signing-and-database-and-cookie-encryption-keys"},"Rotation of HMAC Token Signing and Database and Cookie Encryption Keys"),(0,o.kt)("p",null,"Rotating database encryption keys is done by prepending the new encryption key\nto the respective configuration value. Assuming configuration"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"secrets:\n  cookie:\n    - the-old-cookie-encryption-key\n  system:\n    - the-old-system-encryption-key\n")),(0,o.kt)("p",null,"one would add the new keys as follows"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"secrets:\n  cookie:\n    - the-new-cookie-encryption-key # the new key must be the first entry\n    - the-old-cookie-encryption-key\n  system:\n    - the-new-system-encryption-key # the new key must be the first entry\n    - the-old-system-encryption-key\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"It is very important that the new key is the first entry in the list as only\nthe first key is used for encryption while all keys from the list are used for\ndecryption. Please note that existing data will not be automatically\nre-encrypted using the new key. Only new data will be signed and encrypted\nusing the new key. It is therefore imperative that the old key is added to the\nlist, unless you want to also invalidate all data that was signed or encrypted\nusing the old key.")),(0,o.kt)("h2",{id:"oauth-20"},"OAuth 2.0"),(0,o.kt)("h3",{id:"audience"},"Audience"),(0,o.kt)("p",null,"There are two types of audience concept in the context of OAuth 2.0 and OpenID\nConnect:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},'OAuth 2.0: Access and Refresh Tokens are "internal-facing". The ',(0,o.kt)("inlineCode",{parentName:"li"},"aud")," claim\nof an OAuth 2.0 Access and Refresh token defines at which ",(0,o.kt)("em",{parentName:"li"},"endpoints")," the\ntoken can be used."),(0,o.kt)("li",{parentName:"ol"},'OpenID Connect: The ID Token is "external-facing". The ',(0,o.kt)("inlineCode",{parentName:"li"},"aud")," claim of an\nOpenID Connect ID Token defines which ",(0,o.kt)("em",{parentName:"li"},"clients")," should accept it.")),(0,o.kt)("p",null,"While modifying the audience of an ID Token is not desirable, specifying the\naudience of an OAuth 2.0 Access Token is. This is not defined as an IETF\nStandard but is considered good practice in certain environments."),(0,o.kt)("p",null,"For this reason, Hydra allows you to control the aud claim of the access token.\nTo do so, you must specify the intended audiences in the OAuth 2.0 Client's\nmetadata on a per-client basis:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'{\n    "client_id": "...",\n    "audience": ["https://api.my-cloud.com/user", "https://some-tenant.my-cloud.com/"]\n}\n')),(0,o.kt)("p",null,"The audience is a list of case-sensitive URLs. ",(0,o.kt)("strong",{parentName:"p"},"URLs must not contain\nwhitespaces"),"."),(0,o.kt)("h4",{id:"oauth-20-authorization-code-implicit-hybrid-flows"},"OAuth 2.0 Authorization Code, Implicit, Hybrid Flows"),(0,o.kt)("p",null,"When performing an OAuth 2.0 authorize code, implicit, or hybrid flow, you can\nrequest audiences at the ",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/auth")," endpoint\n",(0,o.kt)("inlineCode",{parentName:"p"},"https://my-hydra.com/oauth2/auth?client_id=...&scope=...&audience=https%3A%2F%2Fapi.my-cloud.com%2Fuser+https%3A%2F%2Fsome-tenant.my-cloud.com%2F"),"\nwhich requests audiences ",(0,o.kt)("inlineCode",{parentName:"p"},"https://api.my-cloud.com/user")," and\n",(0,o.kt)("inlineCode",{parentName:"p"},"https://some-tenant.my-cloud.com/"),"."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"audience")," query parameter may contain multiple strings separated by a\nurl-encoded space (",(0,o.kt)("inlineCode",{parentName:"p"},"+")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"%20"),"). The audience values themselves must also be\nurl encoded. The values will be validated against the whitelisted audiences\ndefined in the OAuth 2.0 Client:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"An OAuth 2.0 Client with the allowed audience ",(0,o.kt)("inlineCode",{parentName:"li"},"https://api.my-cloud/user")," is\nallowed to request audience values ",(0,o.kt)("inlineCode",{parentName:"li"},"https://api.my-cloud/user"),(0,o.kt)("inlineCode",{parentName:"li"},"https://api.my-cloud/user/1234")," but not ",(0,o.kt)("inlineCode",{parentName:"li"},"https://api.my-cloud/not-user")," nor\n",(0,o.kt)("inlineCode",{parentName:"li"},"https://something-else/"),".")),(0,o.kt)("p",null,"The requested audience from the query parameter is then part of the login and\nconsent request payload as field ",(0,o.kt)("inlineCode",{parentName:"p"},"requested_access_token_audience"),". You can then\nalter the audience using ",(0,o.kt)("inlineCode",{parentName:"p"},"grant_audience.access_token")," when accepting the\nconsent request:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'hydra.acceptConsentRequest(challenge, {\n  // ORY Hydra checks if requested audiences are allowed by the client, so we can simply echo this.\n  grant_audience: {\n    access_token: response.requested_access_token_audience,\n    // or, for example:\n    // access_token: ["https://api.my-cloud/not-user"]\n  },\n\n  // ... remember: false\n  // ...\n})\n')),(0,o.kt)("p",null,"When introspecting the OAuth 2.0 Access Token, the response payload will include\nthe audience:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'{\n  "active": true,\n  // ...\n  "audience": ["https://api.my-cloud/user", "https://api.my-cloud/user/1234"]\n}\n')),(0,o.kt)("h4",{id:"oauth-20-client-credentials-grant"},"OAuth 2.0 Client Credentials Grant"),(0,o.kt)("p",null,"When performing the client credentials grant, the audience parameter from the\nPOST body of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/token")," is decoded and validated according to the same\nrules of the previous section, except for the login and consent part which does\nnot exist for this flow."),(0,o.kt)("h3",{id:"json-web-tokens"},"JSON Web Tokens"),(0,o.kt)("p",null,"ORY Hydra issues opaque OAuth 2.0 Access Tokens per default for the following\nreasons:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"OAuth 2.0 Access Tokens represent internal state but are public\nknowledge:")," An Access Token often contains internal data (e.g. session data)\nor other sensitive data (e.g. user roles and permissions) and is sometimes\nused as a means of transporting system-relevant information in a stateless\nmanner. Therefore, making these tokens transparent (by using JSON Web Tokens\nas Access Tokens) comes with risk of exposing this information accidentally,\nand with the downside of not storing this information in the OAuth 2.0 Access\nToken at all."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"JSON Web Tokens can not hold secrets:")," Unless encrypted, JSON Web Tokens\ncan be read by everyone, including 3rd Parties. Therefore, they can not keep\nsecrets. This point is similar to (1), but it is important to stress this."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Access Tokens as JSON Web Tokens can not be revoked:"),' Well, you can revoke\nthem, but they will be considered valid until the "expiry" of the token is\nreached. Unless, of course, you have a blacklist or check with Hydra if the\ntoken was revoked, which however defeats the purpose of using JSON Web Tokens\nin the first place.'),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Certain OpenID Connect features will not work")," when using JSON Web Tokens\nas Access Tokens, such as the pairwise subject identifier algorithm."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"There is a better solution: Use\n",(0,o.kt)("a",{parentName:"strong",href:"https://github.com/ory/oathkeeper"},"ORY Oathkeeper"),"!"),' ORY Oathkeeper is a\nproxy you deploy in front of your services. It will "convert" ORY Hydra\'s\nopaque Access Tokens into JSON Web Tokens for your backend services. This\nallows your services to work without additional REST Calls while solving all\nprevious points. ',(0,o.kt)("strong",{parentName:"li"},"We really recommend this option if you want JWTs!"))),(0,o.kt)("p",null,"If you are not convinced that ORY Oathkeeper is the right tool for the job, you\ncan still enable JSON Web Tokens in ORY Hydra by setting:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"strategies:\n  access_token: jwt\n")),(0,o.kt)("p",null,"Be aware that only access tokens are formatted as JSON Web Tokens. Refresh\ntokens are not impacted by this strategy. By performing OAuth 2.0 Token\nIntrospection you can check if the token is still valid. If a token is revoked\nor otherwise blacklisted, the OAuth 2.0 Token Introspection will return\n",(0,o.kt)("inlineCode",{parentName:"p"},'{ "active": false }'),". This is useful when you do not want to rely only on the\ntoken's expiry."),(0,o.kt)("h4",{id:"json-web-token-validation"},"JSON Web Token Validation"),(0,o.kt)("p",null,"You can validate JSON Web Tokens issued by ORY Hydra by pointing your ",(0,o.kt)("inlineCode",{parentName:"p"},"jwt"),"\nlibrary (e.g. ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/auth0/node-jwks-rsa"},"node-jwks-rsa"),") to\n",(0,o.kt)("inlineCode",{parentName:"p"},"http://ory-hydra-public-api/.well-known/jwks.json"),". All necessary keys are\navailable there."),(0,o.kt)("h3",{id:"oauth-20-client-authentication-with-privatepublic-keypairs"},"OAuth 2.0 Client Authentication with private/public keypairs"),(0,o.kt)("p",null,"ORY Hydra supports OAuth 2.0 Client Authentication with RSA and ECDSA\nprivate/public keypairs with currently supported signing algorithms:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"RS256 (default), RS384, RS512"),(0,o.kt)("li",{parentName:"ul"},"PS256, PS384, PS512"),(0,o.kt)("li",{parentName:"ul"},"ES256, ES384, ES512")),(0,o.kt)("p",null,"This authentication method replaces the classic HTTP Basic Authorization and\nHTTP POST Authorization schemes. Instead of sending the ",(0,o.kt)("inlineCode",{parentName:"p"},"client_id")," and\n",(0,o.kt)("inlineCode",{parentName:"p"},"client_secret"),", you authenticate the client with a signed JSON Web Token."),(0,o.kt)("p",null,"To enable this feature for a specific OAuth 2.0 Client, you must set\n",(0,o.kt)("inlineCode",{parentName:"p"},"token_endpoint_auth_method")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"private_key_jwt")," and register the public key of\nthe RSA/ECDSA signing key either using the ",(0,o.kt)("inlineCode",{parentName:"p"},"jwks_uri")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"jwks")," fields of the\nclient."),(0,o.kt)("p",null,"When authenticating the client at the token endpoint, you generate and sign\n(with the RSA/ECDSA private key) a JSON Web Token with the following claims:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"iss"),": REQUIRED. Issuer. This MUST contain the client_id of the OAuth Client."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"sub"),": REQUIRED. Subject. This MUST contain the client_id of the OAuth Client."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"aud"),": REQUIRED. Audience. The aud (audience) Claim. Value that identifies the\nAuthorization Server (ORY Hydra) as an intended audience. The Authorization\nServer MUST verify that it is an intended audience for the token. The Audience\nSHOULD be the URL of the Authorization Server's Token Endpoint."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"jti"),": REQUIRED. JWT ID. A unique identifier for the token, which can be used\nto prevent reuse of the token. These tokens MUST only be used once, unless\nconditions for reuse were negotiated between the parties; any such negotiation\nis beyond the scope of this specification."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"exp"),": REQUIRED. Expiration time on or after which the ID Token MUST NOT be\naccepted for processing."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"iat"),": OPTIONAL. Time at which the JWT was issued.")),(0,o.kt)("p",null,"When making a request to the ",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/token")," endpoint, you include\n",(0,o.kt)("inlineCode",{parentName:"p"},"client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),"\nand ",(0,o.kt)("inlineCode",{parentName:"p"},"client_assertion=<signed-jwt>")," in the request body:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"POST /oauth2/token HTTP/1.1\nHost: my-hydra.com\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=authorization_code&\ncode=i1WsRn1uB1&\nclient_id=s6BhdRkqt3&\nclient_assertion_type=\nurn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&\nclient_assertion=PHNhbWxwOl ... ZT\n")),(0,o.kt)("p",null,"Here's what a client with a ",(0,o.kt)("inlineCode",{parentName:"p"},"jwks")," containing one RSA public key looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "client_id": "rsa-client-jwks",\n  "jwks": {\n    "keys": [\n      {\n        "kty": "RSA",\n        "n": "jL7h5wc-yeMUsHGJHc0xe9SbTdaLKXMHvcIHQck20Ji7SvrHPdTDQTvZtTDS_wJYbeShcCrliHvbJRSZhtEe0mPJpyWg3O_HkKy6_SyHepLK-_BR7HfcXYB6pVJCG3BW-lVMY7gl5sULFA74kNZH50h8hdmyWC9JgOHn0n3YLdaxSWlhctuwNPSwqwzY4qtN7_CZub81SXWpKiwj4UpyB10b8rM8qn35FS1hfsaFCVi0gQpd4vFDgFyqqpmiwq8oMr8RZ2mf0NMKCP3RXnMhy9Yq8O7lgG2t6g1g9noWbzZDUZNc54tv4WGFJ_rJZRz0jE_GR6v5sdqsDTdjFquPlQ",\n        "e": "AQAB",\n        "use": "sig",\n        "kid": "rsa-jwk"\n      }\n    ]\n  },\n  "token_endpoint_auth_method": "private_key_jwt",\n  "token_endpoint_auth_signing_alg": "RS256"\n}\n')),(0,o.kt)("p",null,"And here is how it looks like for a ",(0,o.kt)("inlineCode",{parentName:"p"},"jwks")," including an ECDSA public key:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "client_id": "ecdsa-client-jwks",\n  "jwks": {\n    "keys": [\n      {\n        "kty": "EC",\n        "use": "sig",\n        "crv": "P-256",\n        "kid": "ecdsa-jwk",\n        "x": "nQjdhpecjZRlworpYk_TJAQBe4QbS8IwHY1DWkfR0w0",\n        "y": "UQfLzHxhc4i3EETUeaAS1vDVFJ-Y01hIESiXqqS86Vc"\n      }\n    ]\n  },\n  "token_endpoint_auth_method": "private_key_jwt",\n  "token_endpoint_auth_signing_alg": "ES256"\n}\n')),(0,o.kt)("p",null,"And with ",(0,o.kt)("inlineCode",{parentName:"p"},"jwks_uri"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "client_id": "client-jwks-uri",\n  "jwks_uri": "http://path-to-my-public/keys.json",\n  "token_endpoint_auth_method": "private_key_jwt",\n  "token_endpoint_auth_signing_alg": "RS256"\n}\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"jwks_uri")," must return a JSON object containing the public keys associated\nwith the OAuth 2.0 Client:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "keys": [\n    {\n      "kty": "RSA",\n      "n": "jL7h5wc-yeMUsHGJHc0xe9SbTdaLKXMHvcIHQck20Ji7SvrHPdTDQTvZtTDS_wJYbeShcCrliHvbJRSZhtEe0mPJpyWg3O_HkKy6_SyHepLK-_BR7HfcXYB6pVJCG3BW-lVMY7gl5sULFA74kNZH50h8hdmyWC9JgOHn0n3YLdaxSWlhctuwNPSwqwzY4qtN7_CZub81SXWpKiwj4UpyB10b8rM8qn35FS1hfsaFCVi0gQpd4vFDgFyqqpmiwq8oMr8RZ2mf0NMKCP3RXnMhy9Yq8O7lgG2t6g1g9noWbzZDUZNc54tv4WGFJ_rJZRz0jE_GR6v5sdqsDTdjFquPlQ",\n      "e": "AQAB",\n      "use": "sig",\n      "kid": "rsa-jwk"\n    }\n  ]\n}\n')),(0,o.kt)("h2",{id:"openid-connect"},"OpenID Connect"),(0,o.kt)("h3",{id:"subject-identifier-algorithms"},"Subject Identifier Algorithms"),(0,o.kt)("p",null,"Hydra supports two\n",(0,o.kt)("a",{parentName:"p",href:"http://openid.net/specs/openid-connect-core-1_0.html#SubjectIDTypes"},"Subject Identifier Algorithms"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"public"),": This provides the same ",(0,o.kt)("inlineCode",{parentName:"li"},"sub")," (subject) value to all Clients\n(default)."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"pairwise"),": This provides a different ",(0,o.kt)("inlineCode",{parentName:"li"},"sub")," value to each Client, so as not to\nenable Clients to correlate the End-User's activities without permission.")),(0,o.kt)("p",null,"You can enable either one or both algorithms using the following configuration\nlayout:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"oidc:\n  subject_identifiers:\n    enabled:\n      - public\n      - pairwise\n")),(0,o.kt)("p",null,"When ",(0,o.kt)("inlineCode",{parentName:"p"},"pairwise")," is enabled, you must also set\n",(0,o.kt)("inlineCode",{parentName:"p"},"oidc.subject_identifiers.pairwise.salt"),". The salt is used to obfuscate the\n",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," value:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"oidc:\n  subject_identifiers:\n    enabled:\n      - public\n      - pairwise\n    pairwise:\n      salt: some-salt\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"This value should not be changed once set in production. Changing it will\ncause all client applications to receive new user IDs from ORY Hydra which will\nlead to serious complications with authentication on their side!")),(0,o.kt)("p",null,"Each OAuth 2.0 Client has a configuration field ",(0,o.kt)("inlineCode",{parentName:"p"},"subject_type"),". The value of\nthat ",(0,o.kt)("inlineCode",{parentName:"p"},"subject_type")," is either ",(0,o.kt)("inlineCode",{parentName:"p"},"public")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"pairwise"),". If the identifier\nalgorithm is enabled, ORY Hydra will choose the right strategy automatically."),(0,o.kt)("p",null,"While ORY Hydra handles ",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," obfuscation out of the box, you may also override\nthis value with your own obfuscated ",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," value by setting\n",(0,o.kt)("inlineCode",{parentName:"p"},"force_subject_identifier")," when accepting the login challenge in your user login\napp."),(0,o.kt)("h3",{id:"using-login_hint-with-different-subject"},"Using login_hint with Different Subject"),(0,o.kt)("p",null,"When a user already logged in with a subject(e.g. user-A), and she would like to\nlogin as another user using login_hint(e.g. login_hint=user-B), directly\naccepting the latter login request in your login provider will make hydra reply:\n",(0,o.kt)("inlineCode",{parentName:"p"},"Subject from payload does not match subject from previous authentication")),(0,o.kt)("p",null,"The suggested flow is:"),(0,o.kt)("p",null,"Check the response from\n",(0,o.kt)("a",{parentName:"p",href:"https://www.ory.sh/hydra/docs/reference/api#get-a-login-request"},"GET login request"),",\nif both the ",(0,o.kt)("inlineCode",{parentName:"p"},"subject")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"login_hint")," are NOT empty and also NOT the same user,\nredirect UserAgent to ",(0,o.kt)("inlineCode",{parentName:"p"},"request_url")," which is appended with '?prompt=login'. This\nwill make hydra ignore the existing authentication, and allow your login\nprovider to login a different subject."),(0,o.kt)("p",null,"For more information on ",(0,o.kt)("inlineCode",{parentName:"p"},"prompt=login")," and other options, please check\n",(0,o.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest"},"Authentication Request"),"."),(0,o.kt)("h2",{id:"cors"},"CORS"),(0,o.kt)("p",null,"Both ORY Hydra's Admin and Public endpoints support CORS. For detailed\ninformation, head over to the exemplary\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ory/hydra/blob/master/docs/config.yaml"},"config file"),"."),(0,o.kt)("p",null,"For CORS to work properly, we encourage to set the following values:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"serve:\n  admin:\n    cors:\n      enabled: true\n      allowed_origins:\n        - https://example.com\n        - https://*.example.com\n      allowed_methods:\n        - POST\n        - GET\n        - PUT\n        - PATCH\n        - DELETE\n      allowed_headers:\n        - Authorization\n      exposed_headers:\n        - Content-Type\n  public:\n    cors:\n      enabled: true\n      allowed_origins:\n        - https://example.com\n        - https://*.example.com\n      allowed_methods:\n        - POST\n        - GET\n        - PUT\n        - PATCH\n        - DELETE\n      allowed_headers:\n        - Authorization\n      exposed_headers:\n        - Content-Type\n")),(0,o.kt)("p",null,"Keep in mind that the OAuth 2.0 Authorization Endpoint (",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/auth"),") does not\nexpose CORS by design. This endpoint should never be consumed in a CORS-fashion.\nSome endpoints (",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/token"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"/userinfo"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/revoke"),") additionally\ninclude URLs listed in field ",(0,o.kt)("inlineCode",{parentName:"p"},"allowed_cors_origins")," of the OAuth 2.0 Client that\nis making the request. For example, OAuth 2.0 Client"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "client_id": "foo",\n  "allowed_cors_origins": ["https://foo-bar.com/"]\n}\n')),(0,o.kt)("p",null,"is allowed to make CORS request to ",(0,o.kt)("inlineCode",{parentName:"p"},"/oauth2/token")," from origin\n",(0,o.kt)("inlineCode",{parentName:"p"},"https://foo-bar.com/")," even if that origin is not listed in\n",(0,o.kt)("inlineCode",{parentName:"p"},"public.cors.allowed_origins"),"."),(0,o.kt)("h2",{id:"cookies"},"Cookies"),(0,o.kt)("p",null,"By default, cookies sent by the Hydra Public endpoints are set without\nexplicitly specifying a SameSite mode. If you wish for these cookies to be set\nwith a mode you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"serve.cookies.same_site_mode")," setting. Possible\nvalues are ",(0,o.kt)("inlineCode",{parentName:"p"},"Strict"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Lax")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"None"),"."),(0,o.kt)("p",null,"If you wish to embed requests to hydra on a third party site (for example an\niframe that periodically polls to check session status) you will need to set the\nmode to ",(0,o.kt)("inlineCode",{parentName:"p"},"None"),"."),(0,o.kt)("p",null,"Some\n",(0,o.kt)("a",{parentName:"p",href:"https://www.chromium.org/updates/same-site/incompatible-clients"},"browser versions"),"\nreject cookies using the ",(0,o.kt)("inlineCode",{parentName:"p"},"Same-Site=None")," attribute. Hydra implements a\n",(0,o.kt)("a",{parentName:"p",href:"https://web.dev/samesite-cookie-recipes/#handling-incompatible-clients"},"workaround"),"\nthat can be enabled by setting ",(0,o.kt)("inlineCode",{parentName:"p"},"serve.cookies.same_site_legacy_workaround")," to\n",(0,o.kt)("inlineCode",{parentName:"p"},"true"),". This workaround is disabled by default, and only takes effect when\n",(0,o.kt)("inlineCode",{parentName:"p"},"serve.cookies.same_site_mode")," is set to ",(0,o.kt)("inlineCode",{parentName:"p"},"None"),"."))}u.isMDXComponent=!0}}]);